<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register Your Copy · WE NOT POOR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css?v=wnp16" />
</head>

<body class="wnp">

  <!-- Top-right utility link -->
  <a href="index.html" class="top-login">
    <span>Back to Home</span>
  </a>

  <main class="wrap">

    <header class="hero">
      <div class="brand-wrap brand-offset">
        <span class="brand">WE NOT POOR</span>
        <span class="brand-accent" aria-hidden="true"></span>
      </div>

      <h1>REGISTER YOUR COPY</h1>
      <p class="sub">
        This is the point where commitment replaces curiosity.
      </p>
    </header>

    <section class="card register-card">

      <div class="field book-code-field">
        <span>Book Code <span class="req">*</span></span>
        <input
          id="code"
          type="text"
          placeholder="WNP-XXXX-XXXX"
          autocomplete="off"
          autocapitalize="characters"
          spellcheck="false"
        />
      </div>

      <div class="field book-code-field" style="margin-top:14px;">
        <span>Email <span class="req">*</span></span>
        <input
          id="email"
          type="email"
          placeholder="you@example.com"
          autocomplete="email"
        />
      </div>

      <div class="actions actions-stack">
        <button class="btn" id="continueBtn" type="button">CONTINUE</button>
        <a class="btn ghost" href="member.html">BACK</a>
      </div>

      <p id="msg" class="note center-note" style="min-height:18px;"></p>

      <p class="note center-note">
        One copy. One entry. Not transferable.
      </p>

    </section>

  </main>

  <style>
    .register-card{
      max-width: 520px;
      margin-left: auto;
      margin-right: auto;
      padding: 22px 20px 24px;
    }

    .book-code-field{
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
    }

    .book-code-field input{ width:100%; }

    .actions-stack{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:16px;
      align-items:center;
    }

    .center-note{
      text-align:center;
      margin-top:14px;
    }

    @media (max-width: 520px){
      .register-card{ max-width: 100%; }
      .book-code-field{ max-width: 100%; }
    }

    .brand-wrap{ display:inline-flex; flex-direction:column; gap:4px; }
    .brand-offset{ align-items:flex-start; }
    .brand-accent{
      display:block;
      width:36px;
      height:3px;
      background: var(--danger, #FF2A2A);
      border-radius:999px;
      margin-left:2px;
    }
  </style>

<script>
  // ✅ Same-origin (Pages -> Worker Functions) endpoint
  const REDEEM_ENDPOINT = "/api/book-codes/redeem";

  const $ = (id) => document.getElementById(id);

  function setMsg(text, isError = true) {
    const el = $("msg");
    el.textContent = text || "";
    el.style.color = isError ? "var(--danger, #FF2A2A)" : "var(--textOnDark, #FFD400)";
  }

  function normalizeCode(v) {
    return String(v || "").trim().toUpperCase();
  }

  function normalizeEmail(v) {
    return String(v || "").trim().toLowerCase();
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function isValidBookCode(code) {
    return /^WNP-[A-Z0-9]{4}-[A-Z0-9]{4}$/.test(code);
  }

  // ✅ Persist staged payload for downstream pages (checkpoint/email-setup)
  function stageAutoPayload({ email, code, data }) {
    const payload = {
      mode: "auto",
      email,
      code,
      member_id: data?.member_id || null,
      // Helpful for debugging / future routing without re-calling redeem
      redeem_response: data || null
    };
    sessionStorage.setItem("wnp_payload", JSON.stringify(payload));
    sessionStorage.setItem("wnp_email", email);
    localStorage.setItem("wnp_email", email);
  }

  // ✅ Authoritative router based on Worker progress fields
  function routeAfterRedeem(data, email, code) {
    const status = String(data?.status || "").toLowerCase();
    if (status === "denied") return "denied.html";
    if (status === "pending") return "decision.html";

    const needsPassword = !!data?.needs_password;

    // If already registered, do NOT send them back through checkpoint again.
    if (data?.already_registered) {
      // If they still need password setup, go to email setup
      if (needsPassword) return `email-setup.html?email=${encodeURIComponent(email)}`;

      // Otherwise send them to login/canonical router
      // (member-access.html is your login + routes forward via /api/me)
      return `member-access.html?email=${encodeURIComponent(email)}`;
    }

    // New redemption: go to auto checkpoint
    // (checkpoint collects upload + answer + checkbox before password setup)
    return `checkpoint.html?email=${encodeURIComponent(email)}&code=${encodeURIComponent(code)}`;
  }

  function setBusy(isBusy) {
    const btn = $("continueBtn");
    btn.disabled = isBusy;
    btn.textContent = isBusy ? "VERIFYING..." : "CONTINUE";
  }

  async function redeem() {
    setMsg("");

    const code = normalizeCode($("code").value);
    const email = normalizeEmail($("email").value);

    if (!code) return setMsg("Book code required.");
    if (!isValidBookCode(code)) return setMsg("Code format must be WNP-XXXX-XXXX.");
    if (!email) return setMsg("Email required.");
    if (!isValidEmail(email)) return setMsg("Enter a valid email.");

    setBusy(true);

    try {
      const r = await fetch(REDEEM_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ code, email })
      });

      const data = await r.json().catch(() => ({}));

      if (!r.ok) {
        setMsg(data?.error || "Could not verify code.");
        setBusy(false);
        return;
      }

      // ✅ Stage payload for the next pages (auto path)
      stageAutoPayload({ email, code, data });

      // ✅ Route based on actual state/progress returned by Worker
      const next = routeAfterRedeem(data, email, code);
      window.location.href = next;

    } catch (e) {
      setMsg("Network error. Try again.");
      setBusy(false);
    }
  }

  // Prefill from query params (optional but helpful)
  (function initPrefill() {
    try {
      const url = new URL(window.location.href);
      const qEmail = normalizeEmail(url.searchParams.get("email") || "");
      const qCode = normalizeCode(url.searchParams.get("code") || "");

      if (qCode) $("code").value = qCode;
      if (qEmail) $("email").value = qEmail;

      // If no email in URL, use prior stored
      if (!qEmail) {
        const carry = (sessionStorage.getItem("wnp_email") || localStorage.getItem("wnp_email") || "").trim();
        if (carry) $("email").value = normalizeEmail(carry);
      }
    } catch (_) {}
  })();

  $("continueBtn").addEventListener("click", redeem);
  $("code").addEventListener("keydown", (e) => { if (e.key === "Enter") redeem(); });
  $("email").addEventListener("keydown", (e) => { if (e.key === "Enter") redeem(); });
</script>

</body>
</html>
