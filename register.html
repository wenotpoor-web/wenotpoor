<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register Your Copy · WE NOT POOR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css?v=3" />
</head>

<body class="wnp">

  <!-- Top-right utility link -->
  <a href="index.html" class="top-login">
    <span>Back to Home</span>
  </a>

  <main class="wrap">

    <header class="hero">
      <!-- Brand with red accent under WE NOT -->
      <div class="brand-wrap brand-offset">
        <span class="brand">WE NOT POOR</span>
        <span class="brand-accent" aria-hidden="true"></span>
      </div>

      <h1>REGISTER YOUR COPY</h1>
      <p class="sub">
        This is the point where commitment replaces curiosity.
      </p>
    </header>

    <section class="card register-card">

      <div class="field book-code-field">
        <span>Book Code <span class="req">*</span></span>
        <input
          id="code"
          type="text"
          placeholder="WNP-XXXX-XXXX"
          autocomplete="off"
        />
      </div>

      <!-- ✅ Email required by the API -->
      <div class="field book-code-field" style="margin-top:14px;">
        <span>Email <span class="req">*</span></span>
        <input
          id="email"
          type="email"
          placeholder="you@example.com"
          autocomplete="email"
        />
      </div>

      <div class="actions actions-stack">
        <!-- ✅ real button now -->
        <button class="btn" id="continueBtn" type="button">CONTINUE</button>
        <a class="btn ghost" href="member.html">BACK</a>
      </div>

      <p id="msg" class="note center-note" style="min-height:18px;"></p>

      <p class="note center-note">
        One copy. One entry. Not transferable.
      </p>

    </section>

  </main>

  <style>
    .register-card{
      max-width: 520px;
      margin-left: auto;
      margin-right: auto;
      padding: 22px 20px 24px;
    }

    .book-code-field{
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
    }

    .book-code-field input{
      width:100%;
    }

    .actions-stack{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:16px;
      align-items:center;
    }

    .center-note{
      text-align:center;
      margin-top:14px;
    }

    @media (max-width: 520px){
      .register-card{ max-width: 100%; }
      .book-code-field{ max-width: 100%; }
    }
  </style>

<script>
  // ✅ Use same-origin relative URLs to avoid cookie/CORS headaches
  const API = "";

  function setMsg(text, isError = true) {
    const el = document.getElementById("msg");
    el.textContent = text || "";
    el.style.color = isError ? "var(--danger, #FF2A2A)" : "var(--textOnDark, #FFD400)";
  }

  function normalizeCode(v) {
    return String(v || "").trim().toUpperCase();
  }

  function normalizeEmail(v) {
    return String(v || "").trim().toLowerCase();
  }

  // ✅ Authoritative router based on Worker progress fields
  function routeAfterRedeem(data, email) {
    // If your Worker returns a direct next_step, honor it.
    // Otherwise infer from the flags (most robust).
    const needsPassword = !!data.needs_password;
    const needsOath = !!data.needs_oath;
    const needsFirstName = !!data.needs_first_name;

    // If they are already registered, do NOT send them to checkpoint again.
    if (data.already_registered) {
      // If they still need password setup, go there
      if (needsPassword) return `email-setup.html?email=${encodeURIComponent(email)}`;

      // If they can login, send to login (or directly to member-access if you prefer)
      // Login is safer because it ensures they have a session cookie.
      return `login.html?email=${encodeURIComponent(email)}`;
    }

    // New redemption path (auto-approved member created)
    // Your locked flow: redeem -> checkpoint (proof) -> email setup -> oath -> name -> member access
    // However: if Worker indicates they already have password, skip email-setup.
    if (!needsPassword) {
      // If password already exists, they can login and proceed from there
      // (login will route them onward based on /api/me)
      return `login.html?email=${encodeURIComponent(email)}`;
    }

    // Default new path: go to checkpoint next
    return `checkpoint.html?email=${encodeURIComponent(email)}`;
  }

  async function redeem() {
    setMsg("");

    const code = normalizeCode(document.getElementById("code").value);
    const email = normalizeEmail(document.getElementById("email").value);

    if (!code) return setMsg("Book code required.");
    if (!/^WNP-[A-Z0-9]{4}-[A-Z0-9]{4}$/.test(code)) return setMsg("Code format must be WNP-XXXX-XXXX.");
    if (!email) return setMsg("Email required.");
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return setMsg("Enter a valid email.");

    const btn = document.getElementById("continueBtn");
    btn.disabled = true;
    btn.textContent = "VERIFYING...";

    try {
      const r = await fetch(`${API}/api/book-codes/redeem`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // ✅ keep cookies if your Worker ever sets any during this step
        credentials: "include",
        body: JSON.stringify({ code, email })
      });

      const data = await r.json().catch(() => ({}));

      if (!r.ok) {
        setMsg(data.error || "Could not verify code.");
        btn.disabled = false;
        btn.textContent = "CONTINUE";
        return;
      }

      // ✅ Route based on actual state/progress returned by the Worker
      const next = routeAfterRedeem(data, email);
      window.location.href = next;

    } catch (e) {
      setMsg("Network error. Try again.");
      btn.disabled = false;
      btn.textContent = "CONTINUE";
    }
  }

  document.getElementById("continueBtn").addEventListener("click", redeem);
  document.getElementById("code").addEventListener("keydown", (e) => { if (e.key === "Enter") redeem(); });
  document.getElementById("email").addEventListener("keydown", (e) => { if (e.key === "Enter") redeem(); });
</script>

</body>
</html>
