<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>We Not Poor — Submit Proof</title>
  <link rel="stylesheet" href="/style.css" />
</head>

<body class="wnp">
  <main class="wrap">
    <header class="hero">
      <!-- ✅ Brand + red accent line under WE NOT -->
      <div class="brand-wrap brand-offset">
        <span class="brand">WE NOT POOR</span>
        <span class="brand-accent" aria-hidden="true"></span>
      </div>

      <h1>Submit Proof</h1>
      <p class="sub">
        Upload your proof. Membership approval is not guaranteed. If approved, you will gain access.
      </p>
    </header>

    <section class="card">
      <div class="card-h">
        <div class="card-title">UPLOADS</div>
        <!-- ✅ API pill removed/hidden -->
      </div>

      <div class="grid-2">
        <label class="field">
          <span>Receipt / Invoice (Amazon or retailer) <span class="req">*</span></span>
          <input id="receipt" type="file" accept="image/png,image/jpeg,image/webp" />
          <div class="muted">PNG/JPG/WEBP • Max 10MB</div>
        </label>

        <label class="field">
        <span>Checkpoint Proof (photo of completed checkpoint) <span class="req">*</span></span>
        <input
        id="checkpoint"
        type="file"
        accept="image/*"
        capture="environment"
        />
        <div class="muted">Photo of Handwritten Checkpoint • Max 10MB</div>
        </label>

      <label class="field">
        <span>Question <span class="req">*</span></span>
        <div class="prompt">
          What lie have you been telling yourself that this book exposed?
        </div>
        <textarea id="answer" rows="5" placeholder="Write the answer. No excuses."></textarea>
      </label>

      <div class="actions">
        <button class="btn" id="uploadBtn">Upload & Continue</button>
        <button class="btn ghost" id="resetBtn" type="button">Reset</button>
      </div>

      <!-- ✅ Hide API status output -->
      <pre class="result" id="result" style="display:none;"></pre>

      <!-- ✅ Centered disclaimer at bottom of card -->
      <div class="muted" style="text-align:center; margin-top:14px; font-weight:700;">
        No guarantees. No promises. Only responsibility.
      </div>
    </section>

    <!-- ✅ Footer: remove copyright line entirely -->
    <footer class="foot foot-center">
      <span></span>
    </footer>
  </main>

  <script>
    const API = "https://wenotpoor-api.wenotpoor.workers.dev";
    const $ = (id) => document.getElementById(id);
    const result = $("result");

    // ✅ Silent status (no UI)
    async function health() {
      try { await fetch(API + "/api/health", { credentials: "include" }); } catch {}
    }
    health();

    // ✅ Keep functionality but keep result hidden unless error
    function setResult(msg, isErr=false) {
      if (!msg) { result.style.display = "none"; return; }
      if (!isErr) { result.style.display = "none"; return; }
      result.style.display = "block";
      result.textContent = msg;
      result.classList.toggle("err", !!isErr);
    }

    $("resetBtn").onclick = () => {
      $("receipt").value = "";
      $("checkpoint").value = "";
      $("answer").value = "";
      sessionStorage.removeItem("wnp_payload");
      setResult("", false);
    };

    function validateFile(file) {
      if (!file) return "Missing file.";
      const okTypes = new Set(["image/png", "image/jpeg", "image/webp"]);
      if (!okTypes.has(file.type)) return "Unsupported file type. Use PNG/JPG/WEBP.";
      if (file.size > 10 * 1024 * 1024) return "File too large. Max 10MB.";
      return null;
    }

    async function uploadOne(file, kind) {
      const form = new FormData();
      form.append("kind", kind); // receipt | checkpoint
      form.append("file", file);

      const r = await fetch(API + "/api/uploads", {
        method: "POST",
        body: form,
        credentials: "include"
      });

      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.error || "Upload failed");
      return data.key;
    }

    $("uploadBtn").onclick = async () => {
      const receipt = $("receipt").files[0];
      const checkpoint = $("checkpoint").files[0];
      const answer = $("answer").value.trim();

      const rErr = validateFile(receipt);
      if (rErr) return setResult("Receipt: " + rErr, true);

      const cErr = validateFile(checkpoint);
      if (cErr) return setResult("Checkpoint proof: " + cErr, true);

      if (!answer) return setResult("Answer the question.", true);

      try {
        const receipt_key = await uploadOne(receipt, "receipt");
        const checkpoint_key = await uploadOne(checkpoint, "checkpoint");

        const payload = {
          mode: "manual",
          receipt_key,
          checkpoint_key,
          answer
        };
        sessionStorage.setItem("wnp_payload", JSON.stringify(payload));

        window.location.href = "/email-setup.html";
      } catch (e) {
        setResult(e.message || "Error during upload.", true);
      }
    };
  </script>
</body>
</html>
