<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>We Not Poor — Manual Submission</title>
  <link rel="stylesheet" href="/style.css" />
</head>

<body class="wnp">
  <main class="wrap">
    <header class="hero">
      <div class="brand">WE NOT POOR</div>
      <h1>Manual Submission</h1>
      <p class="sub">
        Upload your proof. Membership approval is not guaranteed. If approved, you will gain access.
      </p>
    </header>

    <section class="card">
      <div class="card-h">
        <div class="card-title">UPLOADS</div>
        <div class="pill" id="apiPill">API: checking…</div>
      </div>

      <div class="grid-2">
        <label class="field">
          <span>Receipt / Invoice (Amazon or retailer)</span>
          <input id="receipt" type="file" accept="image/png,image/jpeg,image/webp" />
          <div class="muted">PNG/JPG/WEBP • Max 10MB</div>
        </label>

        <label class="field">
          <span>Checkpoint Proof (photo of completed checkpoint)</span>
          <input id="checkpoint" type="file" accept="image/png,image/jpeg,image/webp" />
          <div class="muted">PNG/JPG/WEBP • Max 10MB</div>
        </label>
      </div>

      <label class="field">
        <span>Question (Required)</span>
        <div class="prompt">
          What lie have you been telling yourself<br/>that this book exposed?
        </div>
        <textarea id="answer" rows="5" placeholder="Write the answer. No excuses."></textarea>
      </label>

      <div class="actions">
        <button class="btn" id="uploadBtn">Upload & Continue</button>
        <button class="btn ghost" id="resetBtn" type="button">Reset</button>
      </div>

      <pre class="result" id="result">Waiting…</pre>
    </section>

    <footer class="foot">
      <span>© We Not Poor</span>
      <span class="muted">No guarantees. No promises. Only responsibility.</span>
    </footer>
  </main>

  <script>
    const API = "https://wenotpoor-api.wenotpoor.workers.dev";
    const $ = (id) => document.getElementById(id);
    const result = $("result");

    function setResult(msg, isErr=false) {
      result.textContent = msg;
      result.classList.toggle("err", !!isErr);
    }

    async function health() {
      try {
        const r = await fetch(API + "/api/health", { credentials: "include" });
        const ok = r.ok;
        $("apiPill").textContent = ok ? "API: online" : "API: offline";
        $("apiPill").classList.toggle("good", ok);
      } catch {
        $("apiPill").textContent = "API: offline";
        $("apiPill").classList.remove("good");
      }
    }
    health();

    $("resetBtn").onclick = () => {
      $("receipt").value = "";
      $("checkpoint").value = "";
      $("answer").value = "";
      sessionStorage.removeItem("wnp_payload");
      setResult("Reset.");
    };

    function validateFile(file) {
      if (!file) return "Missing file.";
      const okTypes = new Set(["image/png", "image/jpeg", "image/webp"]);
      if (!okTypes.has(file.type)) return "Unsupported file type. Use PNG/JPG/WEBP.";
      if (file.size > 10 * 1024 * 1024) return "File too large. Max 10MB.";
      return null;
    }

    async function uploadOne(file, kind) {
      const form = new FormData();
      form.append("kind", kind); // receipt | checkpoint
      form.append("file", file);

      const r = await fetch(API + "/api/uploads", {
        method: "POST",
        body: form,
        credentials: "include"
      });

      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.error || "Upload failed");
      return data.key;
    }

    $("uploadBtn").onclick = async () => {
      const receipt = $("receipt").files[0];
      const checkpoint = $("checkpoint").files[0];
      const answer = $("answer").value.trim();

      const rErr = validateFile(receipt);
      if (rErr) return setResult("Receipt: " + rErr, true);

      const cErr = validateFile(checkpoint);
      if (cErr) return setResult("Checkpoint proof: " + cErr, true);

      if (!answer) return setResult("Answer the question.", true);

      try {
        setResult("Uploading receipt…");
        const receipt_key = await uploadOne(receipt, "receipt");

        setResult("Uploading checkpoint proof…");
        const checkpoint_key = await uploadOne(checkpoint, "checkpoint");

        // Stage for email-setup screen
        const payload = {
          mode: "manual",
          receipt_key,
          checkpoint_key,
          answer
        };
        sessionStorage.setItem("wnp_payload", JSON.stringify(payload));

        setResult("Uploads complete. Continuing…");
        window.location.href = "/email-setup.html";
      } catch (e) {
        setResult(e.message || "Error during upload.", true);
      }
    };
  </script>
</body>
</html>
