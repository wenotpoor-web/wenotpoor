<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>We Not Poor — Email & Password</title>

  <!-- APPLY SITE THEME -->
  <link rel="stylesheet" href="style.css" />
</head>

<body class="wnp">
  <main class="wrap">

    <header class="hero">
      <!-- ✅ Brand with red accent line under WE NOT -->
      <div class="brand-wrap brand-offset">
        <span class="brand">WE NOT POOR</span>
        <span class="brand-accent" aria-hidden="true"></span>
      </div>

      <h1>Email &amp; Password Setup</h1>
      <p class="sub">
        Confirm your email. We’ll send a temporary password. Then you’ll set your permanent password.
      </p>
    </header>

    <!-- STEP 1 -->
    <section class="card">
      <div class="card-h">
        <div class="card-title">STEP 1 — CONFIRM EMAIL</div>
        <!-- ✅ API status hidden -->
        <div class="pill" id="apiPill" style="display:none;"></div>
      </div>

      <div class="grid-2">
        <div class="field">
          <span>Email</span>
          <input id="email" type="email" placeholder="Enter Email" autocomplete="email" />
        </div>

        <div class="field">
          <span>Confirm Email</span>
          <input id="email2" type="email" placeholder="Retype Email" autocomplete="email" />
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="sendTemp" type="button">Send temporary password</button>
        <!-- ✅ Reset button removed -->
      </div>

      <!-- ✅ Temp password example note removed -->

      <div class="result err" id="step1Err" style="display:none;"></div>
    </section>

    <!-- STEP 2 -->
    <section class="card">
      <div class="card-h">
        <div class="card-title">STEP 2 — SET PASSWORD</div>
        <div class="muted">Minimum 8 chars, include a number + special character.</div>
      </div>

      <div class="grid-2">
        <div class="field">
          <span>Temporary Password</span>
          <input id="temp" type="text" placeholder="Enter Temporary Password" />
        </div>

        <div class="field">
          <span>New Password</span>
          <input id="pw" type="password" placeholder="••••••••" autocomplete="new-password" />
        </div>

        <div class="field">
          <span>Confirm New Password</span>
          <input id="pw2" type="password" placeholder="••••••••" autocomplete="new-password" />
        </div>

        <!-- ✅ Mode UI hidden (but still present for script compatibility) -->
        <div class="field" style="display:none;">
          <span>Mode</span>
          <div class="mode">
            <label class="radio">
              <input type="radio" name="mode" value="manual" checked />
              <span>Manual approval (receipt)</span>
            </label>
            <label class="radio">
              <input type="radio" name="mode" value="auto" />
              <span>Auto approval (book code)</span>
            </label>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="confirmPw" type="button">Set password &amp; continue</button>
      </div>

      <pre class="result" id="result">Waiting…</pre>
    </section>

    <!-- ✅ Footer centered, copyright removed -->
    <footer class="foot foot-center">
      <span class="muted">Membership is not open. It is earned.</span>
    </footer>
  </main>

  <!-- ✅ Red accent line under WE NOT (page-safe in case CSS missing it) -->
  <style>
    .brand-wrap{
      display:inline-flex;
      flex-direction:column;
      gap:4px;
    }
    .brand-offset{ align-items:flex-start; }
    .brand-accent{
      display:block;
      width:36px;
      height:3px;
      background: var(--danger, #FF2A2A);
      border-radius:999px;
      margin-left:2px;
    }
  </style>

  <script>
    const API = "https://wenotpoor-api.wenotpoor.workers.dev";

    const $ = (id) => document.getElementById(id);
    const result = $("result");

    function setResult(msg, isErr=false) {
      result.textContent = msg;
      result.classList.toggle("err", !!isErr);
    }

    function setStep1Err(msg="") {
      const el = $("step1Err");
      if (!msg) { el.style.display = "none"; el.textContent = ""; return; }
      el.style.display = "block";
      el.textContent = msg;
    }

    function modeValue() {
      const sel = document.querySelector('input[name="mode"]:checked');
      return sel ? sel.value : "manual";
    }

    function pullCarryover() {
      const raw = sessionStorage.getItem("wnp_payload");
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    // ✅ Health check still runs (optional) but UI is hidden
    async function health() {
      try {
        const r = await fetch(API + "/api/health", { credentials: "include" });
        const ok = r.ok;
        $("apiPill").textContent = ok ? "API: online" : "API: offline";
        $("apiPill").classList.toggle("good", ok);
      } catch {
        $("apiPill").textContent = "API: offline";
        $("apiPill").classList.remove("good");
      }
    }
    health();

    $("sendTemp").onclick = async () => {
      setStep1Err("");
      const email = $("email").value.trim();
      const email2 = $("email2").value.trim();

      if (!email || !email2) { setStep1Err("Enter email twice."); return setResult("Enter email twice.", true); }
      if (email !== email2) { setStep1Err("Emails do not match."); return setResult("Emails do not match.", true); }

      setResult("Sending temporary password…");

      const payload = pullCarryover() || {};
      payload.email = email;
      payload.mode = modeValue();
      sessionStorage.setItem("wnp_payload", JSON.stringify(payload));

      const r = await fetch(API + "/api/auth/temp-password/request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email }),
        credentials: "include"
      });

      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        setStep1Err(data.error || "Failed to send temp password.");
        return setResult(data.error || "Failed to send temp password.", true);
      }

      setResult("Temporary password sent. Check your inbox (and spam).");
    };

    $("confirmPw").onclick = async () => {
      const email = $("email").value.trim();
      const temp = $("temp").value.trim();
      const pw = $("pw").value;
      const pw2 = $("pw2").value;
      const mode = modeValue();

      if (!email) return setResult("Enter your email.", true);
      if (!temp) return setResult("Enter the temporary password you received.", true);
      if (!pw || !pw2) return setResult("Enter your new password twice.", true);
      if (pw !== pw2) return setResult("New passwords do not match.", true);
      if (pw.length < 8) return setResult("Password must be at least 8 characters.", true);

      const hasNum = /[0-9]/.test(pw);
      const hasSpec = /[^A-Za-z0-9]/.test(pw);
      if (!hasNum || !hasSpec) return setResult("Include at least 1 number and 1 special character.", true);

      setResult("Setting password…");

      const staged = pullCarryover() || {};
      const r = await fetch(API + "/api/auth/temp-password/confirm", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email,
          temp_password: temp,
          new_password: pw,
          mode,
          staged
        }),
        credentials: "include"
      });

      const data = await r.json().catch(() => ({}));
      if (!r.ok) return setResult(data.error || "Failed to set password.", true);

      sessionStorage.removeItem("wnp_payload");

      // ROUTING (use your real filenames)
      if (mode === "manual") {
        window.location.href = "/decision.html";
      } else {
        window.location.href = "/oath.html";
      }
    };
  </script>
</body>
</html>
