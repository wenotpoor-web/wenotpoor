<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Decision</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 24px; max-width: 720px; margin: 0 auto; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 16px; }
    button { padding: 12px 16px; border-radius: 10px; border: 0; cursor: pointer; font-weight: 600; }
    input { padding: 10px; width: 100%; margin: 6px 0 12px; border-radius: 10px; border: 1px solid #ccc; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .muted { color: #666; }
    .error { color: #b00020; }
  </style>
</head>
<body>
  <h1>Membership Decision</h1>
  <p class="muted">Log in to view your current status.</p>

  <div class="card">
    <div class="row">
      <label>Email</label>
      <input id="email" type="email" autocomplete="email" />

      <label>Password</label>
      <input id="password" type="password" autocomplete="current-password" />

      <button id="loginBtn">Log In</button>
      <div id="msg" class="error"></div>
    </div>
  </div>

  <div id="statusCard" class="card" style="display:none;">
    <h2 id="statusTitle"></h2>
    <p id="statusText" class="muted"></p>
    <p id="deniedReason" class="error" style="display:none;"></p>
    <button id="enterBtn" style="display:none;">ENTER</button>
  </div>

  <script>
    const API_BASE = ""; // same domain; adjust only if your API is on a different host

    const $ = (id) => document.getElementById(id);
    const msg = (t="") => { $("msg").textContent = t; };

    function showStatus(status, reason) {
      $("statusCard").style.display = "block";
      $("deniedReason").style.display = "none";
      $("enterBtn").style.display = "none";

      if (status === "pending") {
        $("statusTitle").textContent = "Pending Activation";
        $("statusText").textContent = "Your submission is under review. You’ll gain access after approval.";
      } else if (status === "approved") {
        $("statusTitle").textContent = "Approved";
        $("statusText").textContent = "You’re approved. Select ENTER to continue to the Oath.";
        $("enterBtn").style.display = "inline-block";
      } else if (status === "denied") {
        $("statusTitle").textContent = "Denied";
        $("statusText").textContent = "Your request was denied.";
        $("deniedReason").style.display = "block";
        $("deniedReason").textContent = reason ? `Reason: ${reason}` : "Reason: (not provided)";
      } else if (status === "active") {
        $("statusTitle").textContent = "Active";
        $("statusText").textContent = "You already have access. Redirecting…";
        setTimeout(() => location.href = "/member-access.html", 600);
      } else if (status === "auto_approved") {
        $("statusTitle").textContent = "Approved";
        $("statusText").textContent = "Continue to the Oath.";
        $("enterBtn").style.display = "inline-block";
      } else {
        $("statusTitle").textContent = "Status";
        $("statusText").textContent = `Current status: ${status}`;
      }
    }

    $("loginBtn").addEventListener("click", async () => {
      msg("");
      const email = $("email").value.trim().toLowerCase();
      const password = $("password").value;

      if (!email || !password) return msg("Email and password are required.");

      const res = await fetch(`${API_BASE}/api/auth/login`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ email, password })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) return msg(data.error || "Login failed.");

      // Expecting worker to return status in JSON
      const status = data.status;
      showStatus(status, data.reason);
    });

    $("enterBtn").addEventListener("click", () => {
      // Approved manual users must go to Oath next (then oath accept -> active)
      location.href = "/oath.html";
    });
  </script>
</body>
</html>
