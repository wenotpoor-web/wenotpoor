<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Show Your Work · WE NOT POOR</title>
  <link rel="stylesheet" href="style.css?v=wnp16" />

  <style>
    /* Center hero like your other pages */
    .hero.hero-center{ text-align:center; }
    .hero.hero-center .brand-wrap{ align-items:center; }
    .hero.hero-center .brand-accent{ margin:0 auto; }
    .hero.hero-center .sub{
      max-width: 760px;
      margin-left:auto;
      margin-right:auto;
    }

    /* Section spacing */
    .field-block{ margin-top: 18px; }
    .fine{ margin-top: 10px; line-height: 1.4; }

    .divider{
      height:1px;
      background: rgba(255,212,0,.22);
      margin: 18px 0;
      border-radius: 999px;
    }

    /* Keep general label rhythm, but tighten the very first one */
    label{ margin-top: 18px; }

    /* ✅ FIX: remove extra space above Email (first field inside the card) */
    .card .field-block:first-child{ margin-top: 0 !important; }
    .card .field-block:first-child label{ margin-top: 0 !important; }

    .questionBox{ margin-top: 10px; margin-bottom: 8px; }

    /* ✅ Make "Question" stand out more */
    .questionLabel{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top: 18px;
      font-weight: 950;
      letter-spacing: .6px;
      text-transform: uppercase;
    }
    .questionLabel::before{
      content:"";
      width:10px;
      height:10px;
      border-radius:999px;
      background: rgba(255,212,0,.95);
      box-shadow: 0 0 0 3px rgba(255,212,0,.12);
      flex: 0 0 auto;
    }

    /* Checkbox row */
    .checkline{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding:14px;
      border-radius:16px;
      margin-top: 18px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,212,0,.22);
    }
    .checkline input[type="checkbox"]{
      appearance:auto;
      width:18px;
      height:18px;
      margin: 2px 0 0 0;
      flex: 0 0 auto;
      accent-color: #FFD400;
    }
    .checkTitle{ font-weight:900; }

    /* Center buttons */
    .btnrow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:22px;
    }

    /* Disabled state: cannot be clicked */
    #crossBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
      pointer-events:none;
      filter: grayscale(15%);
    }

    /* Enabled state: RED + WHITE letters */
    #crossBtn.ready{
      background:#FF2A2A !important;
      color:#FFFFFF !important;
      border:1px solid rgba(255,42,42,.8);
    }
    #crossBtn.ready:hover{ filter: brightness(1.05); }
  </style>
</head>

<body class="wnp">
  <main class="wrap">

    <header class="hero hero-center">
      <div class="brand-wrap brand-offset">
        <span class="brand">WE NOT POOR</span>
        <span class="brand-accent" aria-hidden="true"></span>
      </div>

      <h1>SHOW YOUR WORK</h1>
      <p class="sub">
        Take a photo of a checkpoint you have completed and upload it, answer the question, and confirm.
        When complete, <b>Cross The Line</b> will unlock.
      </p>
    </header>

    <section class="card">
      <div class="field-block">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
      </div>

      <div class="field-block">
        <div class="fine" style="margin-top:0;">
        <label for="file">Please upload a clear photo of <b>your physical book</b> showing the checkpoint page
          (the printed checkpoint inside your copy).</label>
        <input id="file" type="file" accept="image/*" />
      </div>

      <div class="divider" aria-hidden="true"></div>

      <div class="field-block">
        <!-- ✅ Styled label -->
        <div class="questionLabel">Question</div>
        <div id="questionText" class="questionBox">
          What is the one belief you are refusing to let die — even though it’s costing you your future?
        </div>
      </div>

      <div class="field-block">
        <label for="answer">Your Answer</label>
        <input id="answer" type="text" placeholder="Type your answer here…" />
      </div>

      <div class="checkline">
        <input id="confirm" type="checkbox" />
        <div>
          <div class="checkTitle">I confirm this is my real checkpoint proof.</div>
          <div class="fine">False submissions will be denied.</div>
        </div>
      </div>

      <div class="btnrow">
        <button id="crossBtn" class="btn" disabled aria-disabled="true">Cross The Line</button>
        <button id="resetBtn" class="btn ghost" type="button">Reset</button>
      </div>
    </section>
  </main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const emailEl = $("email");
  const fileEl = $("file");
  const answerEl = $("answer");
  const confirmEl = $("confirm");
  const crossBtn = $("crossBtn");
  const resetBtn = $("resetBtn");
  const questionTextEl = $("questionText");

  const CHECKPOINT_ID = "checkpoint_1";
  const QUESTION_TEXT = (questionTextEl?.textContent || "").trim();

  let uploadedKeys = [];
  let lastUploadOk = false;

  // Email carry-forward logic:
  // 1) ?email= / ?e=
  // 2) sessionStorage wnp_email
  // 3) localStorage wnp_email
  function getEmailFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return (params.get("email") || params.get("e") || "").trim();
  }
  function normalizeEmail(v) { return (v || "").trim().toLowerCase(); }
  function loadCarryEmail() {
    const fromUrl = normalizeEmail(getEmailFromUrl());
    const fromSession = normalizeEmail(sessionStorage.getItem("wnp_email") || "");
    const fromLocal = normalizeEmail(localStorage.getItem("wnp_email") || "");
    return fromUrl || fromSession || fromLocal || "";
  }
  function applyCarryEmail() {
    const email = loadCarryEmail();
    if (email) {
      emailEl.value = email;
      sessionStorage.setItem("wnp_email", email);
      localStorage.setItem("wnp_email", email);
    }
    emailEl.disabled = false;
    emailEl.readOnly = false;
  }

  emailEl.addEventListener("input", () => {
    const v = normalizeEmail(emailEl.value);
    if (v) {
      sessionStorage.setItem("wnp_email", v);
      localStorage.setItem("wnp_email", v);
    }
    setCrossState();
  });

  function allComplete() {
    const email = normalizeEmail(emailEl.value);
    const hasFile = !!(fileEl.files && fileEl.files.length > 0);
    const hasAnswer = (answerEl.value || "").trim().length > 0;
    const hasCheck = !!confirmEl.checked;
    return !!email && hasFile && hasAnswer && hasCheck && lastUploadOk && uploadedKeys.length > 0;
  }

  function setCrossState() {
    const ok = allComplete();
    crossBtn.disabled = !ok;
    crossBtn.setAttribute("aria-disabled", String(!ok));
    crossBtn.classList.toggle("ready", ok);
  }

  async function uploadCheckpointImage() {
    uploadedKeys = [];
    lastUploadOk = false;
    setCrossState();

    const file = fileEl.files?.[0];
    if (!file) return;

    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch(`/api/uploads?kind=checkpoint`, {
      method: "POST",
      body: fd,
      credentials: "include",
    });

    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch {}

    if (!res.ok) {
      uploadedKeys = [];
      lastUploadOk = false;
      setCrossState();
      return;
    }

    const keys = [];
    if (data) {
      if (Array.isArray(data.keys)) keys.push(...data.keys);
      if (typeof data.key === "string") keys.push(data.key);
    }

    if (!keys.length) {
      uploadedKeys = [];
      lastUploadOk = false;
      setCrossState();
      return;
    }

    uploadedKeys = keys;
    lastUploadOk = true;
    setCrossState();
  }

  async function submitAutoCheckpoint() {
    if (!allComplete()) return;

    const email = normalizeEmail(emailEl.value);
    const answer = (answerEl.value || "").trim();

    const res = await fetch(`/api/auto-checkpoint/submit`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      credentials: "include",
      body: JSON.stringify({
        email,
        checkpoint_id: CHECKPOINT_ID,
        image_keys: uploadedKeys,
        answer,
        question: QUESTION_TEXT
      }),
    });

    if (!res.ok) return;

    window.location.href = `email-setup.html?email=${encodeURIComponent(email)}`;
  }

  fileEl.addEventListener("change", async () => {
    uploadedKeys = [];
    lastUploadOk = false;
    setCrossState();

    if (fileEl.files?.length) {
      try { await uploadCheckpointImage(); } catch { setCrossState(); }
    }
  });

  ["input","change","keyup"].forEach(evt => {
    answerEl.addEventListener(evt, setCrossState);
    confirmEl.addEventListener(evt, setCrossState);
  });

  crossBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    try { await submitAutoCheckpoint(); } catch {}
  });

  resetBtn.addEventListener("click", () => {
    fileEl.value = "";
    answerEl.value = "";
    confirmEl.checked = false;
    uploadedKeys = [];
    lastUploadOk = false;
    setCrossState();
  });

  applyCarryEmail();
  setCrossState();
})();
</script>
</body>
</html>
