<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkpoint · WE NOT POOR</title>

  <style>
    :root{
      --bg:#000;
      --panel:#0b0b0b;
      --text:#FFD400;
      --muted:rgba(255,212,0,.75);
      --line:rgba(255,212,0,.22);
      --danger:#FF2A2A;
      --radius:16px;
      --font:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}
    .wrap{max-width:860px;margin:0 auto;padding:22px}
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
    }
    h1{margin:0 0 10px;font-size:22px;letter-spacing:.4px}
    p{margin:8px 0;color:var(--muted);line-height:1.35}
    label{display:block;margin:14px 0 8px;color:var(--text);font-weight:600}
    input[type="email"], input[type="text"], textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#000;
      color:var(--text);
      outline:none;
    }
    input[type="file"]{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px dashed var(--line);
      background:#000;
      color:var(--muted);
    }
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 720px){
      .row.two{grid-template-columns:1fr 1fr}
    }

    .checkline{
      display:flex;gap:10px;align-items:flex-start;
      margin-top:14px;padding:12px;border:1px solid var(--line);
      border-radius:12px;background:#000;
    }
    .checkline input{margin-top:2px}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    button{
      appearance:none;border:0;border-radius:14px;
      padding:12px 16px;
      font-weight:800;
      cursor:pointer;
    }
    .btn{
      background:var(--text);
      color:#000;
    }
    .btn:disabled{
      opacity:.35;
      cursor:not-allowed;
    }
    .btn-ghost{
      background:transparent;
      color:var(--text);
      border:1px solid var(--line);
    }
    .status{
      margin-top:14px;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#000;
      color:var(--muted);
      white-space:pre-wrap;
      word-break:break-word;
      min-height:44px;
    }
    .status.bad{border-color:rgba(255,42,42,.5); color:#ffd0d0}
    .status.good{border-color:rgba(22,193,114,.45); color:#c8ffe6}
    .fine{font-size:12px;color:var(--muted);margin-top:10px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Checkpoint Proof</h1>
      <p>Upload your checkpoint proof, answer the question, and confirm. When complete, <b>Cross The Line</b> will unlock.</p>

      <div class="row two">
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
          <p class="fine">Use the same email you used to register your copy.</p>
        </div>

        <div>
          <label for="checkpointId">Checkpoint</label>
          <select id="checkpointId">
            <option value="">Select…</option>
            <option value="checkpoint_1">Checkpoint 1</option>
          </select>
          <p class="fine">If you later want this driven dynamically, we can wire it in — but it’s not required.</p>
        </div>
      </div>

      <label for="file">Upload Photo (Proof)</label>
      <input id="file" type="file" accept="image/*" />

      <label for="answer">Answer the Question</label>
      <input id="answer" type="text" placeholder="Type your answer here…" />

      <div class="checkline">
        <input id="confirm" type="checkbox" />
        <div>
          <div style="font-weight:700;color:var(--text)">I confirm this is my real checkpoint proof.</div>
          <div class="fine">False submissions will be denied.</div>
        </div>
      </div>

      <div class="btnrow">
        <button id="crossBtn" class="btn" disabled>Cross The Line</button>
        <button id="resetBtn" class="btn-ghost" type="button">Reset</button>
      </div>

      <div id="status" class="status">Waiting…</div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const emailEl = $("email");
  const checkpointEl = $("checkpointId");
  const fileEl = $("file");
  const answerEl = $("answer");
  const confirmEl = $("confirm");
  const crossBtn = $("crossBtn");
  const resetBtn = $("resetBtn");
  const statusEl = $("status");

  let uploadedKeys = []; // image_keys returned from /api/uploads
  let lastUploadOk = false;

  function setStatus(msg, kind = "") {
    statusEl.classList.remove("bad","good");
    if (kind) statusEl.classList.add(kind);
    statusEl.textContent = msg;
  }

  function canEnable() {
    const hasFile = fileEl.files && fileEl.files.length > 0;
    const hasAnswer = (answerEl.value || "").trim().length > 0;
    const hasCheck = confirmEl.checked;
    // require upload success too (so “complete” really means complete)
    return hasFile && hasAnswer && hasCheck && lastUploadOk && uploadedKeys.length > 0;
  }

  function refreshButton() {
    crossBtn.disabled = !canEnable();
  }

  async function uploadCheckpointImage() {
    uploadedKeys = [];
    lastUploadOk = false;

    const file = fileEl.files?.[0];
    if (!file) {
      setStatus("Select a file to upload.", "bad");
      refreshButton();
      return;
    }

    setStatus("Uploading proof image…");

    const fd = new FormData();
    fd.append("file", file);

    // ✅ Upload endpoint requested by you
    const res = await fetch(`/api/uploads?kind=checkpoint`, {
      method: "POST",
      body: fd,
      credentials: "include",
    });

    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch {}

    if (!res.ok) {
      setStatus(`Upload failed (${res.status}).\n${text}`, "bad");
      refreshButton();
      return;
    }

    // Expecting a shape like: { ok:true, key:"...", keys:["..."] } (varies by your Worker)
    const keys = [];
    if (data) {
      if (Array.isArray(data.keys)) keys.push(...data.keys);
      if (typeof data.key === "string") keys.push(data.key);
    }

    if (keys.length === 0) {
      setStatus(`Upload succeeded but returned no key(s).\n${text}`, "bad");
      refreshButton();
      return;
    }

    uploadedKeys = keys;
    lastUploadOk = true;
    setStatus(`Upload complete.\nStored key(s): ${uploadedKeys.join(", ")}`, "good");
    refreshButton();
  }

  async function submitAutoCheckpoint() {
    const email = (emailEl.value || "").trim();
    const checkpoint_id = (checkpointEl.value || "").trim();
    const answer = (answerEl.value || "").trim();

    if (!email) { setStatus("Email is required.", "bad"); return; }
    if (!checkpoint_id) { setStatus("Checkpoint selection is required.", "bad"); return; }
    if (!answer) { setStatus("Answer is required.", "bad"); return; }
    if (!confirmEl.checked) { setStatus("You must confirm.", "bad"); return; }
    if (!uploadedKeys.length) { setStatus("Upload your proof image first.", "bad"); return; }

    setStatus("Submitting checkpoint…");

    // ✅ Submit endpoint requested by you
    const res = await fetch(`/api/auto-checkpoint/submit`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      credentials: "include",
      body: JSON.stringify({
        email,
        checkpoint_id,
        image_keys: uploadedKeys,
        answer
      }),
    });

    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch {}

    if (!res.ok) {
      setStatus(`Submit failed (${res.status}).\n${text}`, "bad");
      return;
    }

    setStatus("Checkpoint accepted. Routing to Email Setup…", "good");

    // ✅ Route requested by you
    setTimeout(() => {
      window.location.href = `email-setup.html`;
    }, 450);
  }

  // --- Events ---
  fileEl.addEventListener("change", async () => {
    // New file => require re-upload
    uploadedKeys = [];
    lastUploadOk = false;
    refreshButton();
    if (fileEl.files?.length) {
      try { await uploadCheckpointImage(); }
      catch (e) { setStatus(`Upload error:\n${String(e)}`, "bad"); }
    }
  });

  ["input","change","keyup"].forEach(evt => {
    answerEl.addEventListener(evt, refreshButton);
    emailEl.addEventListener(evt, refreshButton);
    checkpointEl.addEventListener(evt, refreshButton);
    confirmEl.addEventListener(evt, refreshButton);
  });

  crossBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    try { await submitAutoCheckpoint(); }
    catch (err) { setStatus(`Unexpected error:\n${String(err)}`, "bad"); }
  });

  resetBtn.addEventListener("click", () => {
    emailEl.value = "";
    checkpointEl.value = "";
    fileEl.value = "";
    answerEl.value = "";
    confirmEl.checked = false;
    uploadedKeys = [];
    lastUploadOk = false;
    setStatus("Reset. Waiting…");
    refreshButton();
  });

  refreshButton();
})();
</script>
</body>
</html>
