<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkpoint · WE NOT POOR</title>

  <style>
    :root{
      --bg:#000;
      --panel:#0b0b0b;
      --text:#FFD400;
      --muted:rgba(255,212,0,.75);
      --line:rgba(255,212,0,.22);
      --outline:rgba(255,212,0,.62);
      --radius:18px;
      --font:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}
    .wrap{max-width:860px;margin:0 auto;padding:22px}
    .card{
      background:linear-gradient(180deg, rgba(255,212,0,.06), rgba(0,0,0,0) 32%), var(--panel);
      border:3px solid var(--outline); /* ✅ thicker */
      border-radius:var(--radius);
      padding:20px;
      box-shadow:0 0 0 1px rgba(0,0,0,.65) inset;
    }
    h1{margin:0 0 10px;font-size:24px;letter-spacing:.3px}
    p{margin:8px 0;color:var(--muted);line-height:1.35}
    label{display:block;margin:16px 0 8px;color:var(--text);font-weight:800;letter-spacing:.2px}
    .fine{font-size:12px;color:var(--muted);margin-top:8px}

    input[type="email"], input[type="text"]{
      width:100%;
      padding:13px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#000;
      color:var(--text);
      outline:none;
    }
    input[type="email"]::placeholder,
    input[type="text"]::placeholder{ color: rgba(255,212,0,.45); }

    input[type="email"][disabled]{
      opacity:.9;
      background:rgba(0,0,0,.7);
      cursor:not-allowed;
    }

    input[type="file"]{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px dashed var(--line);
      background:#000;
      color:var(--muted);
    }

    .questionBox{
      margin-top:6px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.65);
      color:var(--text);
      font-weight:700;
      line-height:1.35;
    }

    .checkline{
      display:flex;gap:12px;align-items:flex-start;
      margin-top:16px;padding:14px;border:1px solid var(--line);
      border-radius:14px;background:#000;
    }
    .checkline input[type="checkbox"]{
      width:18px;height:18px;margin-top:3px;accent-color:var(--text);
    }
    .checkTitle{font-weight:900;color:var(--text)}

    .btnrow{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px}
    button{
      appearance:none;border:0;border-radius:16px;
      padding:12px 16px;font-weight:900;cursor:pointer;
    }
    .btn{background:var(--text);color:#000}
    .btn:disabled{opacity:.35;cursor:not-allowed}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--line)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Checkpoint Proof</h1>
      <p>Upload your checkpoint proof, answer the question, and confirm. When complete, <b>Cross The Line</b> will unlock.</p>

      <label for="email">Email</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
      <div class="fine">This is pulled from your registration.</div>

      <label for="file">Upload Photo (Proof)</label>
      <input id="file" type="file" accept="image/*" />

      <label>Question</label>
      <div id="questionText" class="questionBox">
        What is the one belief you are refusing to let die — even though it’s costing you your future?
      </div>

      <label for="answer">Your Answer</label>
      <input id="answer" type="text" placeholder="Type your answer here…" />

      <div class="checkline">
        <input id="confirm" type="checkbox" />
        <div>
          <div class="checkTitle">I confirm this is my real checkpoint proof.</div>
          <div class="fine">False submissions will be denied.</div>
        </div>
      </div>

      <div class="btnrow">
        <button id="crossBtn" class="btn" disabled>Cross The Line</button>
        <button id="resetBtn" class="btn-ghost" type="button">Reset</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const emailEl = $("email");
  const fileEl = $("file");
  const answerEl = $("answer");
  const confirmEl = $("confirm");
  const crossBtn = $("crossBtn");
  const resetBtn = $("resetBtn");
  const questionTextEl = $("questionText");

  const CHECKPOINT_ID = "checkpoint_1";
  const QUESTION_TEXT = (questionTextEl?.textContent || "").trim();

  let uploadedKeys = [];
  let lastUploadOk = false;

  function getEmailFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return (params.get("email") || params.get("e") || "").trim();
  }

  function setEmailFromRegister() {
    // ✅ Primary: pull from register -> checkpoint via querystring
    const fromUrl = getEmailFromUrl();

    // ✅ Fallback only if someone loads checkpoint directly (not from register)
    const fromStorage = (localStorage.getItem("wnp_email") || "").trim();

    const email = fromUrl || fromStorage;

    if (email) {
      emailEl.value = email;
      emailEl.disabled = true;               // ✅ user shouldn’t re-enter it
      localStorage.setItem("wnp_email", email); // keep it consistent for later pages
    } else {
      emailEl.disabled = false;              // if no email found, allow entry
    }
  }

  function canEnable() {
    const email = (emailEl.value || "").trim();
    const hasFile = !!(fileEl.files && fileEl.files.length > 0);
    const hasAnswer = (answerEl.value || "").trim().length > 0;
    const hasCheck = !!confirmEl.checked;
    return !!email && hasFile && hasAnswer && hasCheck && lastUploadOk && uploadedKeys.length > 0;
  }

  function refreshButton() {
    crossBtn.disabled = !canEnable();
  }

  async function uploadCheckpointImage() {
    uploadedKeys = [];
    lastUploadOk = false;

    const file = fileEl.files?.[0];
    if (!file) { refreshButton(); return; }

    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch(`/api/uploads?kind=checkpoint`, {
      method: "POST",
      body: fd,
      credentials: "include",
    });

    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch {}

    if (!res.ok) {
      uploadedKeys = [];
      lastUploadOk = false;
      refreshButton();
      return;
    }

    const keys = [];
    if (data) {
      if (Array.isArray(data.keys)) keys.push(...data.keys);
      if (typeof data.key === "string") keys.push(data.key);
    }

    if (!keys.length) {
      uploadedKeys = [];
      lastUploadOk = false;
      refreshButton();
      return;
    }

    uploadedKeys = keys;
    lastUploadOk = true;
    refreshButton();
  }

  async function submitAutoCheckpoint() {
    const email = (emailEl.value || "").trim();
    const answer = (answerEl.value || "").trim();

    if (!email || !answer || !confirmEl.checked || !uploadedKeys.length) return;

    const res = await fetch(`/api/auto-checkpoint/submit`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      credentials: "include",
      body: JSON.stringify({
        email,
        checkpoint_id: CHECKPOINT_ID,
        image_keys: uploadedKeys,
        answer,
        question: QUESTION_TEXT
      }),
    });

    if (!res.ok) return;

    // ✅ carry email forward to email-setup
    window.location.href = `email-setup.html?email=${encodeURIComponent(email)}`;
  }

  // Events
  fileEl.addEventListener("change", async () => {
    uploadedKeys = [];
    lastUploadOk = false;
    refreshButton();

    if (fileEl.files?.length) {
      try { await uploadCheckpointImage(); } catch {}
    }
  });

  ["input","change","keyup"].forEach(evt => {
    answerEl.addEventListener(evt, refreshButton);
    confirmEl.addEventListener(evt, refreshButton);
    emailEl.addEventListener(evt, refreshButton);
  });

  crossBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    try { await submitAutoCheckpoint(); } catch {}
  });

  resetBtn.addEventListener("click", () => {
    // Keep email (pulled from register)
    fileEl.value = "";
    answerEl.value = "";
    confirmEl.checked = false;
    uploadedKeys = [];
    lastUploadOk = false;
    refreshButton();
  });

  // init
  setEmailFromRegister();
  refreshButton();
})();
</script>
</body>
</html>
